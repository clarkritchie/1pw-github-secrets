---

name: Set Secrets

on:
  workflow_dispatch:
    inputs:
      repo:
        description: "Select the Git repository"
        type: choice
        required: true
        options:
          - milestones_api
          - docker_shared

      environment:
        description: "Select the environment or repo"
        type: choice
        default: "dev"
        options:
          - dev
          - staging
          - prod
          - repo

env:
  VAULT: "set-github-secrets"
  DEBUG: "true"

jobs:
  set-secrets-from-1pw:
    name: Read secrets from 1Password and Push to GitHub
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Configure 1Password Service Account
        uses: 1password/load-secrets-action/configure@v1
        with:
          # Persist the 1Password Service Account Authorization token
          # for next steps.
          # Keep in mind that every single step in the job is now
          # able to access the token.
          service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: Get Secure Note from ${{ env.VAULT }}/${{ inputs.repo }}_${{ inputs.environment }} and Push to ${{ github.event.inputs.repo }}
        run: |
          FILE=$(mktemp)
          # Note that the notes are named by convention
          op read --out-file ${FILE} --force "op://${{ env.VAULT }}/${{ inputs.repo }}_${{ inputs.environment }}/notesPlain" > /dev/null
          # cat ${FILE}

          cat <<-EOT
          GITHUB_ACCESS_TOKEN=${{ secrets.BLUEBOARD_BOT_PAT }}
          GITHUB_REPO_OWNER=blueboard
          ENVIRONMENT=${{ github.event.inputs.environment }}
          EOT > git.env
          cat git.env

          python3 -m venv venv
          source ./venv/bin/activate
          pip3 install -r requirements.txt
          ENVIRONMENT=${{ github.event.inputs.environment }} GITHUB_REPO=${{ github.event.inputs.repo }}" ENV_FILE=${FILE} python3 main.py